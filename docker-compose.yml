services:
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333" # REST API
      - "6334:6334" # gRPC
    volumes:
      - qdrant:/qdrant/storage
    healthcheck:
      test:
        - CMD-SHELL
        - bash -c ':> /dev/tcp/127.0.0.1/6333' || exit 1
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - rag

  embedder:
    build:
      context: .
      dockerfile: packages/embedder/Dockerfile
    ports:
      - "3003:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/status"]
      interval: 5s
      timeout: 10s
      retries: 30
    networks:
      - rag

  indexer:
    build:
      context: .
      dockerfile: packages/indexer/Dockerfile
    ports:
      - "3002:8000"
    environment:
      - QDRANT__HOST=qdrant
      - EMBEDDING__URL=http://embedder:8000/embed
    volumes:
      - ./knowledge_base:/app/knowledge_base
    depends_on:
      qdrant:
        condition: service_healthy
      embedder:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/status"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - rag

  chat:
    build:
      context: .
      dockerfile: packages/chat/Dockerfile
    ports:
      - "3001:8000"
    env_file: .env
    environment:
      - QDRANT__HOST=qdrant
      - SERVER__RELOAD=false
      - EMBEDDING__URL=http://embedder:8000/embed
    volumes:
      - ./knowledge_base:/app/knowledge_base
    depends_on:
      qdrant:
        condition: service_healthy
      embedder:
        condition: service_healthy
    networks:
      - rag

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    ports:
      - "3000:8080"
    environment:
      - OPENAI_API_BASE_URL=http://chat:8000/v1
      - WEBUI_AUTH=false
      - HF_HUB_OFFLINE=true
    volumes:
      - open_webui:/app/backend/data
    depends_on:
      - chat
    networks:
      - rag

networks:
  rag:
    driver: bridge

volumes:
  qdrant:
  open_webui:
